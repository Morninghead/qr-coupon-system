<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Card Templates</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .template-list { list-style: none; padding: 0; }
        .template-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .template-item:last-child { border-bottom: none; }
        .template-info { flex-grow: 1; }
        .template-info h3 { margin: 0 0 5px 0; }
        .template-info p { margin: 0; color: #666; font-size: 14px; }
        .template-actions a { text-decoration: none; padding: 8px 12px; border-radius: 4px; margin-left: 10px; font-weight: bold; }
        .edit-btn { background-color: #ffc107; color: #333; }
        .use-btn { background-color: #28a745; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h1>Manage Card Templates</h1>
    <a href="/card-editor.html" style="margin-bottom: 20px; display: inline-block;">+ Create New Template</a>
    <ul id="template-list" class="template-list">
        <!-- Templates will be loaded here -->
        <p>Loading templates...</p>
    </ul>
</div>

<script>
    let _supabase;
    const baseUrl = window.location.origin;

    async function initializeApp() {
        try {
            const response = await fetch(`${baseUrl}/.netlify/functions/get-config`);
            const config = await response.json();
            _supabase = supabase.createClient(config.supabaseUrl, config.supabaseKey);

            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) {
                document.body.innerHTML = '<h1>Please log in to access this page.</h1>';
                return;
            }
            
            await loadTemplates();
        } catch (error) {
            console.error('Initialization failed:', error);
            document.getElementById('template-list').innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
        }
    }

    async function loadTemplates() {
        const listEl = document.getElementById('template-list');
        try {
            const { data, error } = await _supabase
                .from('card_templates')
                .select('id, template_name, orientation, updated_at')
                .order('updated_at', { ascending: false });

            if (error) throw error;

            if (data.length === 0) {
                listEl.innerHTML = '<p>No templates found. Please create one.</p>';
                return;
            }

            listEl.innerHTML = ''; // Clear loading message
            data.forEach(template => {
                const item = document.createElement('li');
                item.className = 'template-item';
                item.innerHTML = `
                    <div class="template-info">
                        <h3>${template.template_name}</h3>
                        <p>Orientation: ${template.orientation} | Last Updated: ${new Date(template.updated_at).toLocaleString()}</p>
                    </div>
                    <div class="template-actions">
                        <a href="/card-editor.html?template_id=${template.id}" class="edit-btn">Edit</a>
                        <a href="/bulk-card-generator.html?template_id=${template.id}" class="use-btn">Use for Bulk Print</a>
                    </div>
                `;
                listEl.appendChild(item);
            });
        } catch (error) {
            console.error('Failed to load templates:', error);
            listEl.innerHTML = `<p style="color:red;">Failed to load templates: ${error.message}</p>`;
        }
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
</script>

</body>
</html>
