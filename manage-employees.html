<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการพนักงาน - Employee Management</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }
    </style>
</head>

<body class="bg-gray-100">

    <div id="login-gate" class="hidden min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-lg shadow-md text-center">
            <h1 class="text-2xl font-bold mb-4">Please Log In</h1>
            <p class="mb-6">You must be logged in to access this page.</p>
            <button onclick="netlifyIdentity.open()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Go to Login
            </button>
        </div>
    </div>


    <div id="main-content" class="hidden container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">จัดการพนักงาน</h1>
        <button onclick="window.location.href='/main-menu.html'"
            class="mb-4 bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
            กลับสู่เมนูหลัก
        </button>

        <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex items-center space-x-4 flex-wrap">
            <select id="department-filter" class="border p-2 rounded">
                <option value="">ทุกแผนก</option>
            </select>
            <select id="status-filter" class="border p-2 rounded">
                <option value="">สถานะทั้งหมด</option>
                <option value="true">ใช้งาน</option>
                <option value="false">ไม่ใช้งาน</option>
            </select>
            <input type="text" id="search-input" class="border p-2 rounded flex-grow" placeholder="ค้นหา/กรอง">
        </div>

        <div class="bg-white p-4 rounded-lg shadow-md">
            <table class="w-full text-left">
                <thead>
                    <tr>
                        <th class="p-2">รูป</th>
                        <th class="p-2">รหัสพนักงาน</th>
                        <th class="p-2">ชื่อ-สกุล</th>
                        <th class="p-2">แผนก</th>
                        <th class="p-2">สถานะ</th>
                        <th class="p-2">Actions</th>
                    </tr>
                </thead>
                <tbody id="employee-table">
                    <!-- Employee rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">แก้ไขข้อมูลพนักงาน</h2>
            <form id="edit-form">
                <input type="hidden" id="edit-employee-id">
                <div class="mb-4">
                    <label for="edit-employee-id-display" class="block text-gray-700">รหัสพนักงาน</label>
                    <input type="text" id="edit-employee-id-display" class="w-full border p-2 rounded" disabled>
                </div>
                <div class="mb-4">
                    <label for="edit-name" class="block text-gray-700">ชื่อ-สกุล</label>
                    <input type="text" id="edit-name" class="w-full border p-2 rounded">
                </div>
                <div class="mb-4">
                    <label for="edit-department" class="block text-gray-700">แผนก</label>
                    <select id="edit-department" class="w-full border p-2 rounded"></select>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="document.getElementById('edit-modal').style.display='none'"
                        class="bg-gray-300 hover:bg-gray-400 text-black py-2 px-4 rounded">ยกเลิก</button>
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">บันทึก</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        const loginGate = document.getElementById('login-gate');
        const mainContent = document.getElementById('main-content');
        const employeeTable = document.getElementById('employee-table');
        const searchInput = document.getElementById('search-input');
        const departmentFilter = document.getElementById('department-filter');
        const statusFilter = document.getElementById('status-filter');
        const editModal = document.getElementById('edit-modal');
        let allEmployees = [];
        let departments = {};

        function getAuthHeader() {
            const user = netlifyIdentity.currentUser();
            if (!user || !user.token) {
                return null;
            }
            return {
                'Authorization': `Bearer ${user.token.access_token}`,
                'Content-Type': 'application/json'
            };
        }

        async function fetchDepartments() {
            const headers = getAuthHeader();
            if (!headers) return;
            try {
                const response = await fetch('/.netlify/functions/get-departments', { headers: { 'Authorization': headers.Authorization } });
                const data = await response.json();
                departments = data.reduce((acc, dept) => {
                    acc[dept.id] = dept.name;
                    return acc;
                }, {});
                setupDepartmentFilter();
                setupEditDepartmentDropdown();
            } catch (error) {
                console.error('Failed to fetch departments:', error);
            }
        }

        function setupDepartmentFilter() {
            departmentFilter.innerHTML = '<option value="">ทุกแผนก</option>';
            for (const id in departments) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = departments[id];
                departmentFilter.appendChild(option);
            }
        }

        function setupEditDepartmentDropdown() {
            const editDepartmentSelect = document.getElementById('edit-department');
            editDepartmentSelect.innerHTML = '';
            for (const id in departments) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = departments[id];
                editDepartmentSelect.appendChild(option);
            }
        }

        async function fetchAndDisplayEmployees() {
            const headers = getAuthHeader();
            if (!headers) return;

            try {
                const response = await fetch('/.netlify/functions/get-employees', { headers: { 'Authorization': headers.Authorization } });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allEmployees = await response.json();
                filterEmployees();
            } catch (error) {
                console.error('Failed to fetch employees:', error);
                employeeTable.innerHTML = `<tr><td colspan="6" class="text-red-500 text-center p-4">Failed to load data.</td></tr>`;
            }
        }

        function filterEmployees() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedDept = departmentFilter.value;
            const selectedStatus = statusFilter.value;

            const filtered = allEmployees.filter(emp => {
                const nameMatch = emp.name.toLowerCase().includes(searchTerm);
                const idMatch = emp.employee_id.toLowerCase().includes(searchTerm);
                const deptMatch = !selectedDept || emp.department_id === selectedDept;
                const statusMatch = selectedStatus === "" || String(emp.is_active) === selectedStatus;
                return (nameMatch || idMatch) && deptMatch && statusMatch;
            });
            displayEmployees(filtered);
        }

        function displayEmployees(employees) {
            employeeTable.innerHTML = '';
            if (employees.length === 0) {
                employeeTable.innerHTML = `<tr><td colspan="6" class="text-center p-4">ไม่พบข้อมูลพนักงาน</td></tr>`;
                return;
            }
            employees.forEach(emp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-2"><img src="${emp.photo_url}" alt="Photo" class="w-12 h-12 rounded-full object-cover"></td>
                    <td class="p-2">${emp.employee_id}</td>
                    <td class="p-2">${emp.name}</td>
                    <td class="p-2">${departments[emp.department_id] || 'N/A'}</td>
                    <td class="p-2">${emp.is_active ? '<span class="text-green-500">ใช้งาน</span>' : '<span class="text-red-500">ไม่ใช้งาน</span>'}</td>
                    <td class="p-2">
                        <button onclick="openEditModal('${emp.id}', '${emp.name}', '${emp.department_id}', '${emp.employee_id}')" class="bg-yellow-500 text-white px-2 py-1 rounded text-sm">Edit</button>
                        <button onclick="deleteEmployee('${emp.id}', '${emp.name}')" class="bg-red-500 text-white px-2 py-1 rounded text-sm">Delete</button>
                    </td>
                `;
                employeeTable.appendChild(row);
            });
        }

        function openEditModal(id, name, departmentId, employeeIdDisplay) {
            document.getElementById('edit-employee-id').value = id;
            document.getElementById('edit-employee-id-display').value = employeeIdDisplay;
            document.getElementById('edit-name').value = name;
            document.getElementById('edit-department').value = departmentId;
            editModal.style.display = 'block';
        }

        async function deleteEmployee(employeeId, employeeName) {
            const headers = getAuthHeader();
            if (!headers) {
                alert('Authentication error. Please log in again.');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${employeeName}?`)) {
                return;
            }

            try {
                const response = await fetch('/.netlify/functions/delete-employee', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ id: employeeId })
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || `HTTP Error: ${response.status}`);
                }
                
                alert('Employee deleted successfully.');
                fetchAndDisplayEmployees(); // Refresh the list
            } catch (error) {
                console.error('Failed to delete employee:', error);
                alert(`Error: ${error.message}`);
            }
        }

        document.getElementById('edit-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const headers = getAuthHeader();
            if (!headers) {
                alert('Authentication error. Please log in again.');
                return;
            }

            const employeeId = document.getElementById('edit-employee-id').value;
            const newName = document.getElementById('edit-name').value;
            const newDepartmentId = document.getElementById('edit-department').value;
            
            const payload = {
                id: employeeId,
                name: newName,
                department_id: newDepartmentId
            };
            
            try {
                const response = await fetch('/.netlify/functions/update-employees', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || `HTTP Error: ${response.status}`);
                }
                
                alert('Changes saved successfully.');
                editModal.style.display = 'none';
                fetchAndDisplayEmployees(); // Refresh the list
            } catch (error) {
                console.error('Failed to save changes:', error);
                alert(`Error: ${error.message}`);
            }
        });


        netlifyIdentity.on('init', user => {
            if (user) {
                loginGate.classList.add('hidden');
                mainContent.classList.remove('hidden');
                fetchDepartments().then(fetchAndDisplayEmployees);
            } else {
                loginGate.classList.remove('hidden');
                mainContent.classList.add('hidden');
            }
        });

        netlifyIdentity.on('login', user => {
            loginGate.classList.add('hidden');
            mainContent.classList.remove('hidden');
            fetchDepartments().then(fetchAndDisplayEmployees);
            netlifyIdentity.close();
        });

        netlifyIdentity.on('logout', () => {
            loginGate.classList.remove('hidden');
            mainContent.classList.add('hidden');
            allEmployees = [];
            employeeTable.innerHTML = '';
        });

        searchInput.addEventListener('input', filterEmployees);
        departmentFilter.addEventListener('change', filterEmployees);
        statusFilter.addEventListener('change', filterEmployees);

    </script>
</body>

</html>
