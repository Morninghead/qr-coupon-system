import { createClient } from '@supabase/supabase-js';

// This function requires the Admin client to bypass RLS for role checking
const supabaseUrl = process.env.SUPABASE_URL;
const serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY; // Use the SERVICE_ROLE_KEY for admin actions
const supabaseAdmin = createClient(supabaseUrl, serviceKey);

export const handler = async (event, context) => {
    // 1. Check if it's a POST request
    if (event.httpMethod !== 'POST') {
        return { statusCode: 405, body: 'Method Not Allowed' };
    }

    try {
        // 2. Get user from JWT (sent by the client)
        const { user } = context.clientContext;
        if (!user) {
            return { statusCode: 401, body: JSON.stringify({ message: 'Authentication required' }) };
        }

        // 3. Verify user's role using their ID
        const { data: profile, error: profileError } = await supabaseAdmin
            .from('profiles')
            .select('role')
            .eq('id', user.sub) // user.sub is the user ID from the JWT
            .single();

        if (profileError || !profile) {
            return { statusCode: 403, body: JSON.stringify({ message: 'Could not verify user role' }) };
        }

        if (!['superuser', 'department_admin'].includes(profile.role)) {
            return { statusCode: 403, body: JSON.stringify({ message: 'Permission denied' }) };
        }

        // 4. Parse the incoming data
        const { employeeIds, couponType } = JSON.parse(event.body);
        if (!employeeIds || !couponType || employeeIds.length === 0) {
            return { statusCode: 400, body: JSON.stringify({ message: 'Missing employee IDs or coupon type' }) };
        }

        // 5. Find the corresponding employee UUIDs from the provided employee_id numbers
        const { data: employees, error: employeesError } = await supabaseAdmin
            .from('Employees')
            .select('id, employee_id')
            .in('employee_id', employeeIds);

        if (employeesError) throw employeesError;

        const foundIds = new Set(employees.map(e => e.employee_id));
        const notFoundIds = employeeIds.filter(id => !foundIds.has(id));

        if (employees.length === 0) {
            return { statusCode: 404, body: JSON.stringify({ message: 'No valid employees found.', notFound: notFoundIds }) };
        }

        // 6. Prepare the coupon data for insertion
        const today = new Date().toISOString().split('T')[0];
        const couponsToInsert = employees.map(emp => ({
            employee_id: emp.id, // This is the UUID
            coupon_date: today,
            coupon_type: couponType,
            status: 'READY'
        }));

        // 7. Insert the new coupons into the database
        const { error: insertError } = await supabaseAdmin
            .from('Daily_Coupons')
            .insert(couponsToInsert);

        if (insertError) throw insertError;

        return {
            statusCode: 200,
            body: JSON.stringify({
                message: `Successfully granted coupons for ${employees.length} employees.`,
                notFound: notFoundIds
            }),
        };

    } catch (error) {
        console.error('Grant Coupon Error:', error);
        return {
            statusCode: 500,
            body: JSON.stringify({ message: 'An internal server error occurred.', error: error.message }),
        };
    }
};
