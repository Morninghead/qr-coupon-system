<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏π‡∏õ‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/qrcode.min.js"></script> <!-- Ensure this path is correct -->
    <style>
        :root {
            --primary-color: #6366F1;
            --light-gray: #F3F4F6;
            --dark-gray: #1F2937;
            --text-gray: #4B5563;
            --border-color: #E5E7EB;
            --success-color: #10B981;
            --error-color: #EF4444;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--light-gray);
            margin: 0;
            padding: 24px;
        }
        .hidden { display: none !important; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .header h1 { color: var(--dark-gray); font-size: 28px; margin: 0; }
        .back-link { color: var(--primary-color); text-decoration: none; font-weight: 600; }
        
        .card {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 32px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            align-items: end;
        }
        .control-group {
            display: flex;
            flex-direction: column;
        }
        .control-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-gray);
        }
        .control-group input, .control-group select, .control-group button {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
        }
        .control-group button {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .control-group button:hover { background-color: #4F46E5; }
        .control-group button:disabled { background-color: #a5b4fc; cursor: not-allowed; }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        th { background-color: #F9FAFB; font-weight: 600; }
        td img.employee-photo-thumb { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; vertical-align: middle; }
        
        .pagination { display: flex; justify-content: center; align-items: center; padding: 24px 0; gap: 8px; }
        .pagination button { padding: 8px 16px; border: 1px solid var(--border-color); background-color: white; border-radius: 8px; cursor: pointer; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #message { margin-top: 20px; padding: 12px; border-radius: 8px; font-weight: 500; text-align: center; }
        .message-success { background-color: #D1FAE5; color: #065F46; }
        .message-error { background-color: #FEE2E2; color: #991B1B; }
        .message-info { background-color: #E0E7FF; color: #3730A3; }

        .card-preview-area h2 { margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 16px; margin-bottom: 24px; }
        .card-preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        .employee-card {
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            width: 280px; 
            height: 177px;
        }
        .employee-card .background { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; }
        .employee-card .card-content { position: relative; z-index: 1; width: 100%; height: 100%; }
        .employee-card .card-element { position: absolute; box-sizing: border-box; display: flex; align-items: center; }
        .employee-card .card-element.img { background-color: transparent; border: none; padding: 0; }
        .employee-card .card-element.qr { justify-content: center; }
        .employee-card .card-element.qr canvas { width: 100% !important; height: 100% !important; }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h1>
            <a class='back-link' href='/menu.html'>‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å</a>
        </div>

        <div class="card">
            <div class="controls-grid">
                <div class="control-group">
                    <label for="template-select">1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Template ‡∏ö‡∏±‡∏ï‡∏£</label>
                    <select id="template-select">
                        <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="search-input">2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                    <input type="text" id="search-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠...">
                </div>
                <div class="control-group">
                    <label for="department-filter">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏Å</label>
                    <select id="department-filter">
                        <option value="all">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="status-filter">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <select id="status-filter">
                        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="active">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Active)</option>
                        <option value="inactive">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Inactive)</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button id="apply-filters-btn">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="table-container">
                <table id="employee-selection-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-employees"></th>
                            <th>‡∏£‡∏π‡∏õ</th>
                            <th>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="employee-table-body">
                        <!-- Employee rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="message" class="hidden"></div>
            <div class="pagination" id="pagination-controls"></div>
        </div>

        <div class="card card-preview-area">
            <h2>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå (<span id="selected-count">0</span> ‡∏Ñ‡∏ô)</h2>
            <div class="card-preview-grid" id="card-preview-grid">
                <p style="text-align: center; color: var(--text-gray); grid-column: 1 / -1;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ Template ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</p>
            </div>
            <button id="print-selected-cards-btn" style="background-color: var(--success-color); margin-top: 20px;" disabled>
                üñ®Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå
            </button>
            <div id="pdf-generation-progress" class="message message-info hidden" style="margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        const mainContent = document.getElementById('main-content');
        let _supabase;
        const baseUrl = window.location.origin;

        const templateSelect = document.getElementById('template-select');
        const searchInput = document.getElementById('search-input');
        const departmentFilter = document.getElementById('department-filter');
        const statusFilter = document.getElementById('status-filter');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const employeeTableBody = document.getElementById('employee-table-body');
        const selectAllCheckbox = document.getElementById('select-all-employees');
        const paginationControls = document.getElementById('pagination-controls');
        const messageDiv = document.getElementById('message');
        const cardPreviewGrid = document.getElementById('card-preview-grid');
        const printSelectedCardsBtn = document.getElementById('print-selected-cards-btn');
        const pdfGenerationProgress = document.getElementById('pdf-generation-progress');
        const selectedCountSpan = document.getElementById('selected-count');

        let allTemplates = [];
        let currentEmployees = [];
        let selectedTemplate = null;
        let currentPage = 1;
        const itemsPerPage = 10;
        let selectedEmployeeIds = new Map();

        const PLACEHOLDER_IMG_URL_40 = 'https://placehold.co/40x40/EEE/31343C?text=N/A';

        async function initializeApp() {
            try {
                const response = await fetch(`${baseUrl}/.netlify/functions/get-config`);
                const config = await response.json();
                _supabase = supabase.createClient(config.supabaseUrl, config.supabaseKey);

                const { data: { session } } = await _supabase.auth.getSession();
                if (!session) {
                    document.body.innerHTML = '<h1>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</h1>';
                    return;
                }

                await Promise.all([
                    loadDepartments(),
                    loadCardTemplates(),
                ]);
                await fetchEmployees(currentPage);

                applyFiltersBtn.addEventListener('click', () => {
                    currentPage = 1;
                    fetchEmployees(currentPage);
                });
                selectAllCheckbox.addEventListener('change', handleSelectAll);
                templateSelect.addEventListener('change', handleTemplateChange);
                printSelectedCardsBtn.addEventListener('click', generatePdfForSelectedCards);

            } catch (error) {
                console.error('Initialization failed:', error);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö: ' + error.message, 'error');
            }
        }
        
        async function loadDepartments() {
            try {
                const { data, error } = await _supabase.from('departments').select('*').order('name');
                if (error) throw error;
                departmentFilter.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å</option>';
                data.forEach(d => {
                    departmentFilter.innerHTML += `<option value="${d.id}">${d.name}</option>`;
                });
            } catch (error) {
                console.error("Failed to load departments:", error);
            }
        }

        async function loadCardTemplates() {
            try {
                const { data, error } = await _supabase.from('card_templates').select('*');
                if (error) throw error;
                allTemplates = data;
                templateSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Template --</option>';
                allTemplates.forEach(t => {
                    templateSelect.innerHTML += `<option value="${t.id}">${t.template_name}</option>`;
                });
            } catch (error) {
                console.error("Failed to load card templates:", error);
                templateSelect.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ</option>';
            }
        }

        async function fetchEmployees(page) {
            currentPage = page;
            showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
            employeeTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>`;

            try {
                const { data: { session } } = await _supabase.auth.getSession();
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: itemsPerPage,
                    search: searchInput.value.trim(),
                    department: departmentFilter.value,
                    status: statusFilter.value,
                });

                const response = await fetch(`${baseUrl}/.netlify/functions/get-employees?${params.toString()}`, {
                    headers: { 'Authorization': `Bearer ${session.access_token}` }
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Failed to fetch data');
                }

                const data = await response.json();
                currentEmployees = data.employees;
                renderEmployeeTable(currentEmployees);
                renderPagination(data.currentPage, data.totalPages, data.totalCount);
                showMessage(currentEmployees.length > 0 ? `‡∏û‡∏ö ${data.totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£` : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', 'success');

            } catch (error) {
                console.error('Error fetching employees:', error);
                showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                employeeTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color: var(--error-color);">${error.message}</td></tr>`;
                paginationControls.innerHTML = '';
            }
        }

        function renderEmployeeTable(employees) {
            employeeTableBody.innerHTML = '';
            if (!employees || employees.length === 0) {
                employeeTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</td></tr>`;
                return;
            }

            employees.forEach(emp => {
                const isChecked = selectedEmployeeIds.has(emp.id);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" data-id="${emp.id}" ${isChecked ? 'checked' : ''}></td>
                    <td><img src="${emp.photo_url || PLACEHOLDER_IMG_URL_40}" class="employee-photo-thumb" onerror="this.src='${PLACEHOLDER_IMG_URL_40}'"></td>
                    <td>${emp.employee_id}</td>
                    <td>${emp.name}</td>
                    <td>${emp.department_name || 'N/A'}</td>
                    <td><span style="color: ${emp.is_active ? 'var(--success-color)' : 'var(--error-color)'}; font-weight: 600;">${emp.is_active ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}</span></td>
                `;
                row.querySelector('input[type="checkbox"]').addEventListener('change', (e) => handleCheckboxChange(e, emp));
                employeeTableBody.appendChild(row);
            });
            updateSelectAllCheckboxState();
        }

        function renderPagination(page, totalPages, totalCount) {
             paginationControls.innerHTML = '';
            if (totalPages <= 1) return;

            paginationControls.innerHTML = `
                <button id="prev-page-btn" ${page === 1 ? 'disabled' : ''}>‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                <span>‡∏´‡∏ô‡πâ‡∏≤ ${page} / ${totalPages} (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
                <button id="next-page-btn" ${page >= totalPages ? 'disabled' : ''}>‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            `;
            document.getElementById('prev-page-btn').addEventListener('click', () => fetchEmployees(currentPage - 1));
            document.getElementById('next-page-btn').addEventListener('click', () => fetchEmployees(currentPage + 1));
        }
        
        function showMessage(message, type) {
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = message;
        }

        function handleCheckboxChange(event, employee) {
            if (event.target.checked) {
                selectedEmployeeIds.set(employee.id, employee);
            } else {
                selectedEmployeeIds.delete(employee.id);
            }
            updateSelectAllCheckboxState();
            updateUI();
        }
        
        function handleSelectAll(event) {
            const isChecked = event.target.checked;
            currentEmployees.forEach(emp => {
                const checkbox = employeeTableBody.querySelector(`input[data-id="${emp.id}"]`);
                if (checkbox) checkbox.checked = isChecked;
                if (isChecked) {
                    selectedEmployeeIds.set(emp.id, emp);
                } else {
                    selectedEmployeeIds.delete(emp.id);
                }
            });
            updateUI();
        }
        
        function updateSelectAllCheckboxState() {
            const allCheckboxes = employeeTableBody.querySelectorAll('input[type="checkbox"]');
            if(allCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                return;
            }
            const checkedCount = Array.from(allCheckboxes).filter(cb => cb.checked).length;
            
            if(checkedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCount === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        function handleTemplateChange() {
            const templateId = templateSelect.value;
            selectedTemplate = templateId ? allTemplates.find(t => t.id == templateId) : null;
            updateUI();
        }

        function updateUI() {
            selectedCountSpan.textContent = selectedEmployeeIds.size;
            printSelectedCardsBtn.disabled = selectedEmployeeIds.size === 0 || !selectedTemplate;
            updatePreviewCards();
        }

        async function updatePreviewCards() {
            cardPreviewGrid.innerHTML = '';
            if (selectedEmployeeIds.size === 0 || !selectedTemplate) {
                cardPreviewGrid.innerHTML = '<p style="text-align: center; color: var(--text-gray); grid-column: 1 / -1;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ Template ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</p>';
                return;
            }

            for (const employee of selectedEmployeeIds.values()) {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'employee-card';
                cardDiv.innerHTML = await generateCardHtml(employee, selectedTemplate);
                cardPreviewGrid.appendChild(cardDiv);

                const qrEl = cardDiv.querySelector('.qr-placeholder');
                if (qrEl && employee.permanent_token && window.QRCode) {
                    new QRCode(qrEl, { text: `${baseUrl}/scanner?token=${employee.permanent_token}`, width: qrEl.offsetWidth || 50, height: qrEl.offsetHeight || 50, colorLight: '#ffffff', colorDark: '#000000', correctLevel: QRCode.CorrectLevel.H });
                }
            }
        }

        // *** THE DEFINITIVE FIX FOR CARD PREVIEW ***
        async function generateCardHtml(employee, template) {
            let elementsHtml = '';
            const layout = template.layout_config || {};

            for (const key in layout) {
                const style = layout[key];
                if (!style) continue; // Skip if style for a key is missing

                // Build a robust style string
                let styleStr = `left: ${style.x || 0}px; top: ${style.y || 0}px; width: ${style.width || 'auto'}px; height: ${style.height || 'auto'}px;`;
                if (style.color) styleStr += ` color: ${style.color};`;
                if (style.fontSize) styleStr += ` font-size: ${style.fontSize}px;`;
                if (style.textAlign) styleStr += ` text-align: ${style.textAlign};`;
                if (style.fontFamily) styleStr += ` font-family: ${style.fontFamily}, sans-serif;`;
                
                let content = '';
                let className = `card-element ${key}`;

                switch (key) {
                    case 'photo':
                        content = `<img src="${employee.photo_url || PLACEHOLDER_IMG_URL_40}" style="width:100%; height:100%; object-fit:cover; border-radius: ${style.borderRadius || '0'};">`;
                        break;
                    case 'logo':
                        content = `<img src="${template.logo_url || ''}" style="width:100%; height:100%; object-fit:contain;">`;
                        break;
                    case 'qr_code':
                        className += ' qr';
                        content = `<div class="qr-placeholder" style="width:100%; height:100%;"></div>`;
                        break;
                    case 'employee_name':
                        content = `<span>${employee.name || ''}</span>`;
                        break;
                    case 'employee_id':
                        content = `<span>${employee.employee_id || ''}</span>`;
                        break;
                    case 'department_name':
                        content = `<span>${employee.department_name || ''}</span>`;
                        break;
                    default: // For custom text fields like 'position', 'company_name'
                        content = `<span>${style.text || ''}</span>`;
                        break;
                }
                
                elementsHtml += `<div class="${className}" style="${styleStr}">${content}</div>`;
            }

            const backgroundHtml = template.background_front_url ? `<img src="${template.background_front_url}" class="background">` : '';
            return `${backgroundHtml}<div class="card-content">${elementsHtml}</div>`;
        }
        
        async function generatePdfForSelectedCards() {
             pdfGenerationProgress.textContent = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${selectedEmployeeIds.size} ‡∏Ñ‡∏ô...`;
             pdfGenerationProgress.classList.remove('hidden');
             printSelectedCardsBtn.disabled = true;

             try {
                const employeesToPrint = Array.from(selectedEmployeeIds.values());
                const { data: { session } } = await _supabase.auth.getSession();
                const response = await fetch(`${baseUrl}/.netlify/functions/generate-print-pdf`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                    body: JSON.stringify({ employees: employeesToPrint, template: selectedTemplate })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Server error during PDF generation.');
                }
                const result = await response.json();
                const link = document.createElement('a');
                link.href = result.pdfData;
                link.download = `employee-cards-${Date.now()}.pdf`;
                link.click();
                showMessage('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
             } catch(error) {
                console.error('PDF Generation Error:', error);
                showMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF: ${error.message}`, 'error');
             } finally {
                pdfGenerationProgress.classList.add('hidden');
                printSelectedCardsBtn.disabled = false;
             }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
