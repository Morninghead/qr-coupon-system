<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bulk Card Generator (Background Job)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn { padding: 10px 18px; border-radius: 8px; font-weight: 600; color: white; border: none; cursor: pointer; transition: background-color 0.2s; }
        .btn-generate { background-color: #28a745; }
        .btn-generate:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: #f9f9f9; }
        .message-box { margin-top: 15px; font-weight: bold; padding: 12px; border-radius: 6px; }
    </style>
</head>
<body>
<div class="container">
    <h1>Bulk Card Generator</h1>
    <a href="/manage-templates.html">‚Üê Back to Manage Templates</a>
    
    <div id="template-info" style="margin-top: 20px; padding: 15px; background: #eef2ff; border-radius: 8px;">
        <h2>Using Template: <span id="template-name-display">Loading...</span></h2>
    </div>

    <div style="margin: 18px 0;">
        <label for="paper-size-select">‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©:
            <select id="paper-size-select"><option value="A4" selected>A4</option><option value="A3">A3</option></select>
        </label>
    </div>

    <div id="employee-list">
        <h3>Select Employees</h3>
        <table id="employee-selection-table" style="width: 100%;">
            <thead>
                <tr>
                    <th style="width: 5%;"><input type="checkbox" id="select-all-employees"/></th>
                    <th>Employee ID</th>
                    <th>Name</th>
                </tr>
            </thead>
            <tbody id="employee-table-body">
                <tr><td colspan="3" style="text-align: center; padding: 20px;">Loading employees...</td></tr>
            </tbody>
        </table>
    </div>

    <br />
    <button id="generate-pdf-btn" class="btn btn-generate" disabled>
        Generate PDF for Selected (<span id="selected-count">0</span>)
    </button>
    
    <!-- <<< FIX: ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà -->
    <div id="pdf-message" class="message-box" style="display: none;"></div>
    <a id="download-link" href="#" style="display: none; margin-top: 10px; font-size: 1.2em; text-align: center; background: #007bff; color: white; padding: 15px; border-radius: 8px; text-decoration: none;" target="_blank">
        üì• Download PDF
    </a>
</div>

<script>
// --- Global Variables ---
let _supabase, selectedTemplate = null, allEmployees = [], selectedEmployeeIds = new Map();
let pollingInterval = null; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞

// --- UI Element References ---
const baseUrl = window.location.origin;
const templateNameEl = document.getElementById('template-name-display');
const employeeTableBody = document.getElementById('employee-table-body');
const selectAllCheckbox = document.getElementById('select-all-employees');
const generateBtn = document.getElementById('generate-pdf-btn');
const selectedCountSpan = document.getElementById('selected-count');
const pdfMessageEl = document.getElementById('pdf-message');
const paperSizeSelect = document.getElementById('paper-size-select');
const downloadLink = document.getElementById('download-link');

// --- Initialization ---
document.addEventListener('DOMContentLoaded', initializeApp);

async function initializeApp() {
    try {
        const response = await fetch(`${baseUrl}/.netlify/functions/get-config`);
        const config = await response.json();
        _supabase = supabase.createClient(config.supabaseUrl, config.supabaseKey);
        
        const urlParams = new URLSearchParams(window.location.search);
        const templateId = urlParams.get('template_id');
        if (!templateId) throw new Error('No template ID provided in URL.');
        
        await Promise.all([
            loadTemplate(templateId),
            fetchAllEmployees()
        ]);
        
        selectAllCheckbox.addEventListener('change', handleSelectAll);
        generateBtn.addEventListener('click', startPdfGenerationJob); // <-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà
    } catch (error) {
        console.error("Initialization Error:", error);
        pdfMessageEl.textContent = `Initialization Error: ${error.message}`;
        pdfMessageEl.style.color = 'red';
        pdfMessageEl.style.display = 'block';
    }
}

// --- Data Loading & UI Rendering (‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏î‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ---
async function loadTemplate(templateId) { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }
async function fetchAllEmployees() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }
function renderEmployeeTable(employees) { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }
function handleCheckboxChange(event, employee) { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }
function handleSelectAll(event) { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }
function updateGenerateButton() { /* ... ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ... */ }


// =========================================================================
// <<< FIX: LOGIC ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö BACKGROUND JOBS >>>
// =========================================================================

/**
 * 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£: ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Job ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
 */
async function startPdfGenerationJob() {
    if (selectedEmployeeIds.size === 0 || !selectedTemplate) return;

    // --- Reset UI ---
    generateBtn.disabled = true;
    generateBtn.textContent = '‚è≥ Processing...';
    pdfMessageEl.style.display = 'block';
    pdfMessageEl.style.color = 'blue';
    pdfMessageEl.textContent = 'Sending request to server...';
    downloadLink.style.display = 'none';
    if (pollingInterval) clearInterval(pollingInterval); // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡πà‡∏≤

    try {
        const { data: { session } } = await _supabase.auth.getSession();
        if (!session) throw new Error("User not authenticated.");

        // --- ‡∏™‡πà‡∏á Request ‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á Job ---
        const response = await fetch(`${baseUrl}/.netlify/functions/request-bulk-pdf`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            },
            body: JSON.stringify({
                template: selectedTemplate,
                employees: Array.from(selectedEmployeeIds.values()),
                paperSize: paperSizeSelect.value
            })
        });

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(errData.message || 'Failed to create job on server.');
        }

        const { jobId } = await response.json();
        pdfMessageEl.textContent = `Job created (ID: ${jobId}). Waiting for worker to process...`;
        
        // --- ‡πÄ‡∏£‡∏¥‡πà‡∏° Polling ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ---
        pollingInterval = setInterval(() => checkJobStatus(jobId), 5000);

    } catch (error) {
        handleJobError(`Error starting job: ${error.message}`);
    }
}

/**
 * 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏ñ‡∏≤‡∏°‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÜ ‡∏ß‡πà‡∏≤‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
 * @param {string} jobId - ID ‡∏Ç‡∏≠‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
 */
async function checkJobStatus(jobId) {
    try {
        const response = await fetch(`${baseUrl}/.netlify/functions/get-job-status?jobId=${jobId}`);
        const data = await response.json();

        pdfMessageEl.textContent = `Current status: ${data.status}...`;
        
        if (data.status === 'completed') {
            handleJobSuccess(data.result_url);
        } else if (data.status === 'failed') {
            handleJobError(`Job failed: ${data.error_message || 'Unknown error'}`);
        }
        // ‡∏ñ‡πâ‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô 'pending' ‡∏´‡∏£‡∏∑‡∏≠ 'processing' ‡∏Å‡πá‡∏à‡∏∞‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ

    } catch (error) {
        handleJobError(`Error checking status: ${error.message}`);
    }
}

/**
 * 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÅ‡∏™‡∏î‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ UI
 * @param {string} url - URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
 */
function handleJobSuccess(url) {
    clearInterval(pollingInterval);
    pdfMessageEl.textContent = '‚úÖ PDF generated successfully!';
    pdfMessageEl.style.color = 'green';
    downloadLink.href = url;
    downloadLink.style.display = 'block';
    generateBtn.disabled = false;
    updateGenerateButton(); // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏°
}

/**
 * 4. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ UI
 * @param {string} message - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á
 */
function handleJobError(message) {
    clearInterval(pollingInterval);
    pdfMessageEl.textContent = `‚ùå ${message}`;
    pdfMessageEl.style.color = 'red';
    generateBtn.disabled = false;
    updateGenerateButton();
}
</script>
</body>
</html>
