<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Card Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* You can copy styles from print-employee-cards.html for a consistent look */
        body { font-family: -apple-system, sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; }
        .btn { padding: 10px 18px; border-radius: 8px; font-weight: 600; color: white; border: none; cursor: pointer; }
        .btn-generate { background-color: #28a745; }
        .btn-generate:disabled { background-color: #a0a0a0; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; border: 1px solid #ddd; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bulk Card Generator</h1>
        <div id="template-info">
            <h2>Using Template: <span id="template-name-display">Loading...</span></h2>
        </div>
        <hr>
        <!-- Add your employee search/filter UI here if you want -->
        <hr>
        <h3>Select Employees</h3>
        <div id="employee-list">
             <table id="employee-selection-table">
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all-employees"></th>
                        <th>รหัสพนักงาน</th>
                        <th>ชื่อ-สกุล</th>
                    </tr>
                </thead>
                <tbody id="employee-table-body">
                    <tr><td colspan="3">Loading employees...</td></tr>
                </tbody>
            </table>
        </div>
        <br>
        <button id="generate-pdf-btn" class="btn btn-generate" disabled>Generate PDF for Selected (<span id="selected-count">0</span>)</button>
        <div id="pdf-message" style="margin-top: 15px;"></div>
    </div>

<script>
    let _supabase;
    const baseUrl = window.location.origin;
    let selectedTemplate = null;
    let allEmployees = [];
    let selectedEmployeeIds = new Map();

    // DOM Elements
    const templateNameEl = document.getElementById('template-name-display');
    const employeeTableBody = document.getElementById('employee-table-body');
    const selectAllCheckbox = document.getElementById('select-all-employees');
    const generateBtn = document.getElementById('generate-pdf-btn');
    const selectedCountSpan = document.getElementById('selected-count');
    const pdfMessageEl = document.getElementById('pdf-message');

    async function initializeApp() {
        try {
            const response = await fetch(`${baseUrl}/.netlify/functions/get-config`);
            const config = await response.json();
            _supabase = supabase.createClient(config.supabaseUrl, config.supabaseKey);

            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) throw new Error('Please log in.');

            const urlParams = new URLSearchParams(window.location.search);
            const templateId = urlParams.get('template_id');
            if (!templateId) throw new Error('No template ID provided in URL.');
            
            await loadTemplate(templateId);
            await fetchAllEmployees();

            selectAllCheckbox.addEventListener('change', handleSelectAll);
            generateBtn.addEventListener('click', generatePdf);

        } catch (error) {
            document.body.innerHTML = `<h1>Error: ${error.message}</h1><a href="/manage-templates.html">Go Back</a>`;
        }
    }

    async function loadTemplate(templateId) {
        const { data, error } = await _supabase.from('card_templates').select('*').eq('id', templateId).single();
        if (error) throw error;
        selectedTemplate = data;
        templateNameEl.textContent = selectedTemplate.template_name;
    }

    async function fetchAllEmployees() {
        const { data, error } = await _supabase.from('combined_employees_view').select('*');
        if (error) throw error;
        allEmployees = data;
        renderEmployeeTable(allEmployees);
    }
    
    function renderEmployeeTable(employees) {
        employeeTableBody.innerHTML = '';
        employees.forEach(emp => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="checkbox" class="employee-checkbox" data-id="${emp.id}"></td>
                <td>${emp.employee_id}</td>
                <td>${emp.name}</td>
            `;
            row.querySelector('.employee-checkbox').addEventListener('change', (e) => handleCheckboxChange(e, emp));
            employeeTableBody.appendChild(row);
        });
    }

    function handleCheckboxChange(event, employee) {
        if (event.target.checked) {
            selectedEmployeeIds.set(employee.id, employee);
        } else {
            selectedEmployeeIds.delete(employee.id);
        }
        updateGenerateButton();
    }
    
    function handleSelectAll(event) {
        const isChecked = event.target.checked;
        document.querySelectorAll('.employee-checkbox').forEach(cb => {
            cb.checked = isChecked;
            const empId = parseInt(cb.dataset.id, 10);
            const employee = allEmployees.find(e => e.id === empId);
            if (isChecked) {
                selectedEmployeeIds.set(employee.id, employee);
            } else {
                selectedEmployeeIds.delete(employee.id);
            }
        });
        updateGenerateButton();
    }

    function updateGenerateButton() {
        const count = selectedEmployeeIds.size;
        selectedCountSpan.textContent = count;
        generateBtn.disabled = count === 0;
    }

    async function generatePdf() {
        if (selectedEmployeeIds.size === 0 || !selectedTemplate) return;
        
        generateBtn.disabled = true;
        pdfMessageEl.textContent = 'Generating PDF, please wait... This may take a moment.';

        try {
            const { data: { session } } = await _supabase.auth.getSession();
            const response = await fetch(`${baseUrl}/.netlify/functions/generate-bulk-pdf`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${session.access_token}`
                },
                body: JSON.stringify({
                    template: selectedTemplate,
                    employees: Array.from(selectedEmployeeIds.values())
                })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.message || 'PDF Generation Failed on Server.');
            }

            const pdfBase64 = await response.text();
            const link = document.createElement('a');
            link.href = `data:application/pdf;base64,${pdfBase64}`;
            link.download = `employee-cards-${Date.now()}.pdf`;
            link.click();
            pdfMessageEl.textContent = 'PDF generated successfully!';

        } catch (error) {
            console.error('PDF Generation Error:', error);
            pdfMessageEl.textContent = `Error: ${error.message}`;
        } finally {
            generateBtn.disabled = false;
        }
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
