<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Card Template Editor with Konva.js</title>
    <script src="https://unpkg.com/konva@9.3.6/konva.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            display: flex;
            gap: 20px;
        }
        .controls {
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 300px;
            height: fit-content;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-group label {
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
        }
        .control-group button, .control-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        .control-group button {
            background-color: #6366F1;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .control-group button:hover {
            background-color: #4f46e5;
        }
        #export-json { background-color: #10B981; }
        #export-json:hover { background-color: #059669; }
        textarea {
            width: 100%;
            height: 150px;
            font-family: monospace;
            font-size: 12px;
        }
        #stage-container {
            border: 1px dashed #ccc;
            background-color: white;
        }
    </style>
</head>
<body>

    <div class="controls">
        <div class="control-group">
            <label for="bg-front-upload">Upload Front Background</label>
            <input type="file" id="bg-front-upload" accept="image/*">
        </div>
        <div class="control-group">
            <label for="bg-back-upload">Upload Back Background</label>
            <input type="file" id="bg-back-upload" accept="image/*">
            <small><i>*การแสดงผลจะอยู่บนพื้นที่เดียวกัน แค่สลับพื้นหลัง*</i></small>
        </div>
        <hr>
        <div class="control-group">
            <label>Add Elements</label>
            <button id="add-photo">Add Employee Photo</button>
            <button id="add-name">Add Employee Name</button>
            <button id="add-id">Add Employee ID</button>
            <button id="add-logo">Add Company Logo</button>
            <button id="add-qr">Add QR Code</button>
        </div>
        <hr>
        <div class="control-group">
            <label>Export Layout</label>
            <button id="export-json">Export Layout as JSON</button>
            <textarea id="json-output" readonly placeholder="JSON output will appear here..."></textarea>
        </div>
    </div>

    <div id="stage-container"></div>

    <script>
        // --- 1. ค่าคงที่และตัวแปรเริ่มต้น ---
        const CARD_WIDTH = 856; // ขนาดบัตรมาตรฐาน 85.6mm x 10
        const CARD_HEIGHT = 540; // ขนาดบัตรมาตรฐาน 54mm x 10

        let selectedShape = null;

        // --- 2. ตั้งค่า Konva Stage และ Layers ---
        const stage = new Konva.Stage({
            container: 'stage-container',
            width: CARD_WIDTH,
            height: CARD_HEIGHT,
        });

        // Layer สำหรับพื้นหลัง
        const backgroundLayer = new Konva.Layer();
        stage.add(backgroundLayer);

        // Layer สำหรับองค์ประกอบต่างๆ
        const elementsLayer = new Konva.Layer();
        stage.add(elementsLayer);

        // Transformer สำหรับปรับขนาดและหมุน
        const transformer = new Konva.Transformer({
            nodes: [],
            keepRatio: true,
            borderStroke: '#6366F1',
            anchorStroke: '#6366F1',
            anchorFill: 'white',
        });
        elementsLayer.add(transformer);


        // --- 3. ฟังก์ชันจัดการพื้นหลัง ---
        function setBackground(imageSrc, layer) {
            layer.destroyChildren(); // ลบพื้นหลังเก่าออก
            const img = new Image();
            img.onload = () => {
                const konvaImage = new Konva.Image({
                    image: img,
                    width: CARD_WIDTH,
                    height: CARD_HEIGHT,
                    name: 'background'
                });
                layer.add(konvaImage);
            };
            img.src = imageSrc;
        }

        document.getElementById('bg-front-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => setBackground(event.target.result, backgroundLayer);
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('bg-back-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => setBackground(event.target.result, backgroundLayer);
                reader.readAsDataURL(file);
            }
        });

        // --- 4. ฟังก์ชันเพิ่มองค์ประกอบลงบนบัตร ---
        function addElement(type) {
            let element;
            const commonProps = {
                x: 50,
                y: 50,
                draggable: true,
                name: type // ใช้ name เพื่อระบุประเภทตอน Export
            };

            switch(type) {
                case 'photo':
                    element = new Konva.Rect({
                        ...commonProps,
                        width: 150, height: 150,
                        fill: '#e0e0e0', stroke: '#bdbdbd', strokeWidth: 2,
                        cornerRadius: 75,
                        name: 'photo'
                    });
                    break;
                case 'name':
                    element = new Konva.Text({
                        ...commonProps,
                        text: 'สมชาย ใจดี',
                        fontSize: 32,
                        fontFamily: 'sans-serif',
                        fill: 'black',
                        name: 'employee_name'
                    });
                    break;
                 case 'id':
                    element = new Konva.Text({
                        ...commonProps,
                        text: 'ID: 12345',
                        fontSize: 24,
                        fontFamily: 'sans-serif',
                        fill: '#424242',
                        name: 'employee_id'
                    });
                    break;
                case 'logo':
                    element = new Konva.Rect({ // Placeholder for logo
                        ...commonProps,
                        width: 100, height: 50,
                        fill: '#e0e0e0', stroke: '#bdbdbd', strokeWidth: 1,
                        name: 'logo'
                    });
                    break;
                case 'qr':
                     element = new Konva.Rect({ // Placeholder for QR code
                        ...commonProps,
                        width: 120, height: 120,
                        fill: '#e0e0e0', stroke: 'black', strokeWidth: 2,
                        name: 'qr_code'
                    });
                    break;
            }
            if (element) {
                elementsLayer.add(element);
            }
        }

        document.getElementById('add-photo').addEventListener('click', () => addElement('photo'));
        document.getElementById('add-name').addEventListener('click', () => addElement('name'));
        document.getElementById('add-id').addEventListener('click', () => addElement('id'));
        document.getElementById('add-logo').addEventListener('click', () => addElement('logo'));
        document.getElementById('add-qr').addEventListener('click', () => addElement('qr'));

        // --- 5. จัดการ Transformer และการเลือกองค์ประกอบ ---
        stage.on('click tap', (e) => {
            // ถ้าคลิกบนพื้นที่ว่าง หรือ background
            if (e.target === stage || e.target.hasName('background')) {
                transformer.nodes([]);
                selectedShape = null;
                return;
            }

            // ถ้าคลิกบนองค์ประกอบที่สามารถแก้ไขได้
            if (e.target.getParent() === elementsLayer && e.target !== transformer) {
                 transformer.nodes([e.target]);
                 selectedShape = e.target;
            }
        });
        
        // --- 6. ฟังก์ชันส่งออก Layout เป็น JSON ---
        document.getElementById('export-json').addEventListener('click', () => {
            const layoutConfig = {};
            elementsLayer.children.forEach(node => {
                // ไม่ต้อง Export transformer
                if (node === transformer) return;

                const name = node.name();
                if (!name) return;
                
                // คำนวณเป็น % เพื่อให้ยืดหยุ่นกับขนาดบัตรจริง
                const config = {
                    x: `${(node.x() / CARD_WIDTH * 100).toFixed(2)}%`,
                    y: `${(node.y() / CARD_HEIGHT * 100).toFixed(2)}%`,
                    width: `${(node.width() * node.scaleX() / CARD_WIDTH * 100).toFixed(2)}%`,
                    height: `${(node.height() * node.scaleY() / CARD_HEIGHT * 100).toFixed(2)}%`,
                    rotation: node.rotation().toFixed(2),
                };

                // เพิ่ม Properties เฉพาะของแต่ละประเภท
                if (name === 'employee_name' || name === 'employee_id') {
                    config.fontSize = '1.2em'; // ใช้ขนาดตัวอักษรแบบสัมพัทธ์
                    config.fontWeight = name === 'employee_name' ? '700' : '400';
                    config.textAlign = 'center';
                }
                
                if (name === 'photo') {
                    config.borderRadius = '50%';
                    config.objectFit = 'cover';
                }

                layoutConfig[name] = config;
            });

            // แสดงผล JSON ใน textarea
            const jsonString = JSON.stringify(layoutConfig, null, 2);
            document.getElementById('json-output').value = jsonString;
            alert('Layout JSON has been generated!');
        });
    </script>
</body>
</html>