<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Template Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        :root { --primary: #6366F1; --light-gray: #f0f2f5; --dark-gray: #1F2937; --text-gray: #4B5563; }
        body { font-family: -apple-system, sans-serif; display: flex; height: 100vh; margin: 0; background-color: var(--light-gray); }
        .sidebar { width: 350px; padding: 20px; background-color: #fff; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card-container { border: 2px dashed #ccc; padding: 20px; background: #fff; }
        .card-preview { position: relative; background-size: cover; background-position: center; overflow: hidden; }
        .card-preview.portrait { width: 255px; height: 405px; }
        .card-preview.landscape { width: 405px; height: 255px; }
        .card-element { position: absolute; border: 1px dashed #3498db; box-sizing: border-box; cursor: move; user-select: none; display: flex; align-items: center; justify-content: center; background: rgba(52, 152, 219, 0.1); }
        .card-element img, .card-element div, .card-element span { width: 100%; height: 100%; object-fit: contain; text-align: center; }
        .card-element:hover .delete-btn { display: block; }
        .delete-btn { display: none; position: absolute; top: -10px; right: -10px; width: 20px; height: 20px; background: #e74c3c; color: white; border: none; border-radius: 50%; cursor: pointer; font-weight: bold; line-height: 20px; text-align: center; }
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, button { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .element-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        #save-template-btn { background-color: #28a745; color: white; font-weight: bold; margin-top: auto; } /* Push to bottom */
        .view-switcher { display: flex; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
        .view-switcher button { width: 50%; border: none; background: #fff; cursor: pointer; border-radius: 0; }
        .view-switcher button.active { background: var(--primary); color: white; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>Card Editor</h2>
    <div class="control-group">
        <label for="template-name">Template Name</label>
        <input type="text" id="template-name" placeholder="e.g., Standard Employee Card">
    </div>
    <div class="control-group">
        <label for="orientation">Orientation</label>
        <select id="orientation">
            <option value="landscape">Landscape</option>
            <option value="portrait">Portrait</option>
        </select>
    </div>
    <hr>
    <h3>Layout Control</h3>
    <div class="control-group">
        <label>Editing Side</label>
        <div class="view-switcher">
            <button id="front-view-btn" class="active">Front</button>
            <button id="back-view-btn">Back</button>
        </div>
    </div>
    <div class="control-group">
        <label for="background-url">Background URL</label>
        <input type="url" id="background-url" placeholder="https://.../bg.jpg">
    </div>
    <div class="control-group">
        <label for="logo-upload">Template Logo</label>
        <input type="file" id="logo-upload" accept="image/png, image/jpeg">
        <img id="logo-preview" src="" style="max-width: 100%; margin-top: 10px;">
    </div>
    <hr>
    <h3>Add Elements</h3>
    <div class="element-buttons">
        <button onclick="addElement('photo')">Photo</button>
        <button onclick="addElement('employee_name')">Name</button>
        <button onclick="addElement('employee_id')">Employee ID</button>
        <button onclick="addElement('department_name')">Department</button>
        <button onclick="addElement('qr_code')">QR Code</button>
        <button onclick="addElement('logo')">Logo</button>
        <button onclick="addElement('text')">Custom Text</button>
    </div>
    <hr>
    <button id="save-template-btn">Save Template</button>
    <a href="/menu.html" style="text-align: center; display: block; margin-top: 10px;">Back to Menu</a>
    <div id="message" style="margin-top: 15px;"></div>
</div>

<div class="main-content">
    <div class="card-container">
        <div id="card-preview" class="card-preview landscape"></div>
    </div>
</div>

<script>
    let _supabase;
    const baseUrl = window.location.origin;
    let currentTemplateId = null;
    let currentSide = 'front';
    let layoutConfigs = { front: {}, back: {} };
    let backgroundUrls = { front: '', back: '' };
    let logoUrl = '';

    // --- DOM Elements ---
    const cardPreview = document.getElementById('card-preview');
    const orientationSelect = document.getElementById('orientation');
    const backgroundUrlInput = document.getElementById('background-url');
    const saveBtn = document.getElementById('save-template-btn');
    const frontViewBtn = document.getElementById('front-view-btn');
    const backViewBtn = document.getElementById('back-view-btn');
    const logoUploadInput = document.getElementById('logo-upload');
    const logoPreview = document.getElementById('logo-preview');

    function switchView(side) {
        currentSide = side;
        frontViewBtn.classList.toggle('active', side === 'front');
        backViewBtn.classList.toggle('active', side === 'back');
        backgroundUrlInput.value = backgroundUrls[side];
        cardPreview.style.backgroundImage = `url('${backgroundUrls[side]}')`;
        renderElements();
    }
    
    function renderElements() {
        cardPreview.innerHTML = '';
        const config = layoutConfigs[currentSide];
        for (const key in config) {
            const element = createVisualElement(key, config[key]);
            cardPreview.appendChild(element);
            makeInteractive(element);
        }
    }

    function createVisualElement(id, config) {
        const el = document.createElement('div');
        el.id = id;
        el.className = 'card-element';
        
        let content = '';
        const type = id.split('-')[0];
        switch(type) {
            case 'photo': content = `<img src="https://placehold.co/100x100/EFEFEF/AAAAAA&text=Photo" alt="Photo">`; break;
            case 'logo': content = `<img src="${logoUrl || 'https://placehold.co/100x40/EFEFEF/AAAAAA&text=Logo'}" alt="Logo">`; break;
            case 'employee_name': content = `<span>John Doe</span>`; break;
            case 'employee_id': content = `<span>12345</span>`; break;
            case 'department_name': content = `<span>Marketing</span>`; break;
            case 'qr_code': content = `<div><img src="https://placehold.co/100x100/333/fff?text=QR" style="width:100%;height:100%;"></div>`; break;
            case 'text': content = `<span contenteditable="true" onblur="updateText(this, '${id}')">${config.text || 'Custom Text'}</span>`; break;
        }
        el.innerHTML = content + '<button class="delete-btn" onclick="removeElement(this.parentElement.id)">X</button>';
        return el;
    }

    function addElement(type) {
        const id = `${type}-${Date.now()}`;
        layoutConfigs[currentSide][id] = { x: 10, y: 10, width: 100, height: type === 'text' ? 20 : 100, text: 'Custom Text' };
        renderElements();
    }
    
    function removeElement(id) {
        delete layoutConfigs[currentSide][id];
        renderElements();
    }
    
    function updateText(span, id) {
        layoutConfigs[currentSide][id].text = span.textContent;
    }

    function makeInteractive(element) {
        const id = element.id;
        const config = layoutConfigs[currentSide][id];
        
        element.style.transform = `translate(${config.x}px, ${config.y}px)`;
        element.style.width = `${config.width}px`;
        element.style.height = `${config.height}px`;

        interact(element)
            .draggable({
                listeners: {
                    move(event) {
                        config.x += event.dx;
                        config.y += event.dy;
                        element.style.transform = `translate(${config.x}px, ${config.y}px)`;
                    }
                }
            })
            .resizable({
                edges: { left: true, right: true, bottom: true, top: true },
                listeners: {
                    move(event) {
                        config.width = event.rect.width;
                        config.height = event.rect.height;
                        Object.assign(element.style, { width: `${event.rect.width}px`, height: `${event.rect.height}px` });
                    }
                }
            });
    }

    async function handleLogoUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        // Use a placeholder name until we have a template ID.
        const fileName = currentTemplateId ? `${currentTemplateId}-logo-${Date.now()}` : `temp-logo-${Date.now()}`;
        const filePath = `card-template-logos/${fileName}`;
        
        try {
            const { error } = await _supabase.storage.from('images').upload(filePath, file, { upsert: true });
            if (error) throw error;
            
            const { data } = _supabase.storage.from('images').getPublicUrl(filePath);
            logoUrl = data.publicUrl;
            logoPreview.src = logoUrl;
            showMessage('Logo uploaded successfully!', 'success');
        } catch(error) {
            console.error('Logo Upload Error:', error);
            showMessage('Logo upload failed: ' + error.message, 'error');
        }
    }

    async function saveTemplate() {
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        try {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) throw new Error('You must be logged in to save.');

            const payload = {
                id: currentTemplateId,
                template_name: document.getElementById('template-name').value,
                orientation: orientationSelect.value,
                logo_url: logoUrl,
                background_front_url: backgroundUrls.front,
                background_back_url: backgroundUrls.back,
                layout_config_front: layoutConfigs.front,
                layout_config_back: layoutConfigs.back
            };

            const response = await fetch(`${baseUrl}/.netlify/functions/upsert-card-template`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.message || 'Failed to save.');
            }
            
            const savedTemplate = await response.json();
            if (!currentTemplateId) {
                currentTemplateId = savedTemplate.id;
                window.history.pushState({}, '', `?template_id=${currentTemplateId}`);
            }
            showMessage('Template saved successfully!', 'success');

        } catch (error) {
            showMessage(error.message, 'error');
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Template';
        }
    }

    // --- Event Listeners and Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Initialize Supabase and check session...
        const response = await fetch(`${baseUrl}/.netlify/functions/get-config`);
        const config = await response.json();
        _supabase = supabase.createClient(config.supabaseUrl, config.supabaseKey);
        
        frontViewBtn.addEventListener('click', () => switchView('front'));
        backViewBtn.addEventListener('click', () => switchView('back'));
        orientationSelect.addEventListener('change', (e) => cardPreview.className = `card-preview ${e.target.value}`);
        backgroundUrlInput.addEventListener('input', (e) => {
            backgroundUrls[currentSide] = e.target.value;
            cardPreview.style.backgroundImage = `url('${e.target.value}')`;
        });
        logoUploadInput.addEventListener('change', handleLogoUpload);
        saveBtn.addEventListener('click', saveTemplate);
        
        switchView('front'); // Start on the front view
    });
    
    function showMessage(msg, type) { /* ... */ }
</script>

</body>
</html>
