<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Template Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        :root { --primary: #6366F1; --light-gray: #f0f2f5; --dark-gray: #1F2937; --text-gray: #4B5563; }
        body { font-family: -apple-system, sans-serif; display: flex; height: 100vh; margin: 0; background-color: var(--light-gray); }
        .sidebar { width: 350px; padding: 20px; background-color: #fff; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card-container { border: 2px dashed #ccc; padding: 20px; background: #fff; }
        .card-preview { position: relative; background-size: cover; background-position: center; overflow: hidden; }
        .card-preview.portrait { width: 255px; height: 405px; }
        .card-preview.landscape { width: 405px; height: 255px; }
        .card-element { position: absolute; border: 1px dashed #3498db; box-sizing: border-box; cursor: move; user-select: none; display: flex; align-items: center; justify-content: center; background: rgba(52, 152, 219, 0.1); }
        .card-element.active-selection { border: 2px solid var(--primary); background: rgba(99, 102, 241, 0.2); }
        .card-element img, .card-element div, .card-element span { width: 100%; height: 100%; object-fit: contain; text-align: center; pointer-events: none; }
        .card-element .photo-img { object-fit: cover; }
        .card-element:hover .delete-btn { display: block; }
        .delete-btn { display: none; position: absolute; top: -10px; right: -10px; width: 20px; height: 20px; background: #e74c3c; color: white; border: none; border-radius: 50%; cursor: pointer; font-weight: bold; line-height: 20px; text-align: center; z-index: 10; }
        .snap-guideline { position: absolute; background-color: #e74c3c; display: none; z-index: 0; }
        .snap-guideline.vertical { width: 1px; height: 100%; top: 0; left: 50%; }
        .snap-guideline.horizontal { height: 1px; width: 100%; left: 0; top: 50%; }
        .control-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="url"], input[type="file"], input[type="number"], select, button { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        input[type="file"] { display: none; }
        .upload-btn-label { display: block; background-color: #f0f0f0; text-align: center; padding: 8px; margin-top: 5px; cursor: pointer; border-radius: 4px; font-size: 12px; border: 1px solid #ccc; }
        .upload-btn-label:hover { background-color: #e0e0e0; }
        .radio-group { display: flex; align-items: center; gap: 15px; border: 1px solid #ccc; border-radius: 4px; padding: 5px; }
        .radio-group input[type="radio"] { width: auto; }
        .radio-group label { margin-bottom: 0; font-weight: normal; }
        .element-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        #save-template-btn { background-color: #28a745; color: white; font-weight: bold; margin-top: 15px; }
        .view-switcher { display: flex; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
        .view-switcher button { width: 50%; border: none; background: #fff; cursor: pointer; border-radius: 0; padding: 10px; }
        .view-switcher button.active { background: var(--primary); color: white; }
        #properties-panel { margin-top: auto; padding-top: 15px; border-top: 1px solid #eee; }
    </style>
</head>
<body>

<div class="sidebar">
    <div>
        <h2 id="editor-title">Create New Template</h2>
        <div class="control-group">
            <label for="template-name">Template Name</label>
            <input type="text" id="template-name" placeholder="e.g., Standard Employee Card">
        </div>
        <div class="control-group">
            <label>Orientation</label>
            <div class="radio-group">
                <input type="radio" id="orientation-landscape" name="orientation" value="landscape" checked>
                <label for="orientation-landscape">Landscape</label>
                <input type="radio" id="orientation-portrait" name="orientation" value="portrait">
                <label for="orientation-portrait">Portrait</label>
            </div>
        </div>
        <hr>
        <h3>Layout Control</h3>
        <div class="control-group">
            <label>Editing Side</label>
            <div class="view-switcher">
                <button id="front-view-btn" class="active">Front</button>
                <button id="back-view-btn">Back</button>
            </div>
        </div>
        <div class="control-group">
            <label for="background-url">Background URL</label>
            <input type="url" id="background-url" placeholder="Paste URL or upload image below">
            <input type="file" id="background-upload-input" accept="image/png, image/jpeg">
            <label for="background-upload-input" class="upload-btn-label">üìÅ Upload Background</label>
        </div>
        <div class="control-group">
            <label for="logo-upload-input">Template Logo</label>
            <input type="file" id="logo-upload-input" accept="image/png, image/jpeg">
            <label for="logo-upload-input" class="upload-btn-label">üìÅ Upload Logo</label>
            <img id="logo-preview" src="" style="max-width: 100%; margin-top: 10px; border: 1px dashed #ccc; min-height: 50px;">
        </div>
        <hr>
        <h3>Add Elements</h3>
        <div class="element-buttons">
            <button onclick="addElement('photo')">Photo</button>
            <button onclick="addElement('employee_name')">Name</button>
            <button onclick="addElement('employee_id')">Employee ID</button>
            <button onclick="addElement('department_name')">Department</button>
            <button onclick="addElement('qr_code')">QR Code</button>
            <button onclick="addElement('logo')">Logo</button>
            <button onclick="addElement('text')">Custom Text</button>
        </div>
    </div>
    
    <div id="properties-panel"></div>

    <button id="save-template-btn">Save Template</button>
    <a href="/menu.html" style="text-align: center; display: block; margin-top: 10px;">Back to Menu</a>
    <div id="message" style="margin-top: 15px;"></div>
</div>

<div class="main-content">
    <div class="card-container">
        <div id="card-preview" class="card-preview landscape"></div>
    </div>
</div>

<script>
// --- Global Variables & UI References ---
let _supabase;
const baseUrl = window.location.origin;
let currentTemplateId = null;
let currentSide = 'front';
let layoutConfigs = { front: {}, back: {} };
let backgroundUrls = { front: '', back: '' };
let logoUrl = '';
let activeElementId = null;

const cardPreview = document.getElementById('card-preview');
const backgroundUrlInput = document.getElementById('background-url');
const backgroundUploadInput = document.getElementById('background-upload-input');
const saveBtn = document.getElementById('save-template-btn');
const frontViewBtn = document.getElementById('front-view-btn');
const backViewBtn = document.getElementById('back-view-btn');
const logoUploadInput = document.getElementById('logo-upload-input');
const logoPreview = document.getElementById('logo-preview');
const templateNameInput = document.getElementById('template-name');
const editorTitle = document.getElementById('editor-title');
const propertiesPanel = document.getElementById('properties-panel');

// --- Functions ---

async function loadTemplateData(templateId) {
    showMessage('Loading template data...', 'info');
    try {
        const { data, error } = await _supabase.from('card_templates').select('*').eq('id', templateId).single();
        if (error) throw error;
        currentTemplateId = data.id;
        templateNameInput.value = data.template_name;
        editorTitle.textContent = `Editing: ${data.template_name}`;
        document.getElementById(`orientation-${data.orientation}`).checked = true;
        cardPreview.className = `card-preview ${data.orientation}`;
        logoUrl = data.logo_url || '';
        logoPreview.src = logoUrl;
        backgroundUrls.front = data.background_front_url || '';
        backgroundUrls.back = data.background_back_url || '';
        layoutConfigs.front = data.layout_config_front || {};
        layoutConfigs.back = data.layout_config_back || {};
        switchView('front');
        showMessage('Template loaded successfully.', 'success');
    } catch (error) {
        showMessage(`Failed to load template: ${error.message}`, 'error');
    }
}

function editTextElement(id) {
    event.stopPropagation();
    const config = layoutConfigs[currentSide][id];
    const newText = prompt("Enter new text:", config.text || "Custom Text");
    if (newText !== null) {
        config.text = newText;
        renderElements();
    }
}

function switchView(side) {
    activeElementId = null;
    updatePropertiesPanel();
    currentSide = side;
    frontViewBtn.classList.toggle('active', side === 'front');
    backViewBtn.classList.toggle('active', side === 'back');
    backgroundUrlInput.value = backgroundUrls[side];
    cardPreview.style.backgroundImage = `url('${backgroundUrls[side]}')`;
    renderElements();
}

function renderElements() {
    cardPreview.innerHTML = '';
    cardPreview.innerHTML += '<div id="vertical-guide" class="snap-guideline vertical"></div><div id="horizontal-guide" class="snap-guideline horizontal"></div>';
    const config = layoutConfigs[currentSide];
    for (const key in config) {
        const element = createVisualElement(key, config[key]);
        cardPreview.appendChild(element);
        makeInteractive(element);
    }
}

function createVisualElement(id, config) {
    const el = document.createElement('div');
    el.id = id;
    el.className = 'card-element';
    let content = '';
    const type = id.split('-')[0];
    const currentLogoSrc = logoPreview.src || 'https://placehold.co/100x40/EFEFEF/AAAAAA&text=Logo';
    
    switch(type) {
        case 'photo':
            const shapeStyle = config.shape === 'circle' ? 'border-radius: 50%;' : '';
            content = `<img src="https://placehold.co/100x100/EFEFEF/AAAAAA&text=Photo" alt="Photo" class="photo-img" style="${shapeStyle}">`;
            break;
        case 'logo': content = `<img src="${currentLogoSrc}" alt="Logo">`; break;
        case 'employee_name':
        case 'employee_id':
        case 'department_name':
        case 'text':
            el.setAttribute('ondblclick', `editTextElement('${id}')`);
            if(type === 'text') el.title = 'Double-click to edit text';
            
            let displayText = 'Sample';
            if (type === 'employee_name') displayText = 'John Doe';
            if (type === 'employee_id') displayText = '12345';
            if (type === 'department_name') displayText = 'Marketing';
            if (type === 'text') displayText = config.text || 'Custom Text';
            
            content = `<span style="font-size:${config.fontSize || 16}px;">${displayText}</span>`;
            break;
        case 'qr_code': 
            content = `<div><img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=example" style="width:100%;height:100%;"></div>`; break;
    }
    el.innerHTML = content + '<button class="delete-btn" onclick="removeElement(this.parentElement.id)">X</button>';
    return el;
}

function addElement(type) {
    const id = `${type}-${Date.now()}`;
    layoutConfigs[currentSide][id] = { 
        x: 10, y: 10, 
        width: 100, height: type.includes('text') || type.includes('name') || type.includes('id') ? 30 : 100, 
        text: 'Custom Text', fontSize: 16, shape: 'rect'
    };
    renderElements();
}

function removeElement(id) {
    event.stopPropagation();
    delete layoutConfigs[currentSide][id];
    activeElementId = null;
    updatePropertiesPanel();
    renderElements();
}

function updatePropertiesPanel() {
    propertiesPanel.innerHTML = '';
    if (!activeElementId) return;

    const config = layoutConfigs[currentSide][activeElementId];
    const type = activeElementId.split('-')[0];
    let panelContent = '<h4>Element Properties</h4>';

    if (['employee_name', 'employee_id', 'department_name', 'text'].includes(type)) {
        panelContent += `
            <div class="control-group">
                <label for="font-size-input">Font Size (px)</label>
                <input type="number" id="font-size-input" value="${config.fontSize || 16}">
            </div>`;
    }
    
    if (type === 'photo') {
        panelContent += `
            <div class="control-group">
                <label>Photo Shape</label>
                <div class="radio-group">
                    <input type="radio" id="shape-rect" name="photoShape" value="rect" ${config.shape !== 'circle' ? 'checked' : ''}>
                    <label for="shape-rect">Rectangle</label>
                    <input type="radio" id="shape-circle" name="photoShape" value="circle" ${config.shape === 'circle' ? 'checked' : ''}>
                    <label for="shape-circle">Circle</label>
                </div>
            </div>`;
    }

    propertiesPanel.innerHTML = panelContent;
    
    const fontSizeInput = document.getElementById('font-size-input');
    if (fontSizeInput) {
        fontSizeInput.addEventListener('input', (e) => {
            config.fontSize = e.target.value;
            renderElements();
        });
    }

    const photoShapeRadios = document.querySelectorAll('input[name="photoShape"]');
    if (photoShapeRadios.length) {
        photoShapeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                config.shape = e.target.value;
                renderElements();
            });
        });
    }
}

function makeInteractive(element) {
    const id = element.id;
    const config = layoutConfigs[currentSide][id];
    element.style.width = `${config.width}px`;
    element.style.height = `${config.height}px`;
    element.style.transform = `translate(${config.x}px, ${config.y}px)`;
    
    if (id === activeElementId) element.classList.add('active-selection');
    
    element.addEventListener('click', (e) => {
        e.stopPropagation();
        activeElementId = id;
        document.querySelectorAll('.card-element').forEach(el => el.classList.remove('active-selection'));
        element.classList.add('active-selection');
        updatePropertiesPanel();
    });

    const verticalGuide = document.getElementById('vertical-guide');
    const horizontalGuide = document.getElementById('horizontal-guide');
    const snapThreshold = 5;

    interact(element).draggable({
        listeners: {
            start(event) { verticalGuide.style.display = 'block'; horizontalGuide.style.display = 'block'; },
            move(event) {
                config.x += event.dx; config.y += event.dy;
                const elementCenterX = config.x + (config.width / 2);
                const elementCenterY = config.y + (config.height / 2);
                const parentCenterX = cardPreview.offsetWidth / 2;
                const parentCenterY = cardPreview.offsetHeight / 2;
                if (Math.abs(elementCenterX - parentCenterX) < snapThreshold) {
                    config.x = parentCenterX - (config.width / 2);
                    verticalGuide.style.backgroundColor = '#28a745';
                } else { verticalGuide.style.backgroundColor = '#e74c3c'; }
                if (Math.abs(elementCenterY - parentCenterY) < snapThreshold) {
                    config.y = parentCenterY - (config.height / 2);
                    horizontalGuide.style.backgroundColor = '#28a745';
                } else { horizontalGuide.style.backgroundColor = '#e74c3c'; }
                event.target.style.transform = `translate(${config.x}px, ${config.y}px)`;
            },
            end(event) { verticalGuide.style.display = 'none'; horizontalGuide.style.display = 'none'; }
        },
        modifiers: [interact.modifiers.restrictRect({ restriction: 'parent' })]
    }).resizable({
        edges: { left: true, right: true, bottom: true, top: true },
        listeners: {
            move(event) {
                config.width = event.rect.width; config.height = event.rect.height;
                config.x += event.deltaRect.left; config.y += event.deltaRect.top;
                Object.assign(event.target.style, {
                    width: `${event.rect.width}px`, height: `${event.rect.height}px`,
                    transform: `translate(${config.x}px, ${config.y}px)`
                });
            }
        },
        modifiers: [
            interact.modifiers.restrictSize({ min: { width: 20, height: 20 } }),
            interact.modifiers.restrictRect({ restriction: 'parent' })
        ]
    });
}

async function uploadImage(file, folder) {
    if (!file) return null;
    const fileExt = file.name.split('.').pop();
    const fileName = `template-${currentTemplateId || 'new'}-${Date.now()}.${fileExt}`;
    const filePath = `${folder}/${fileName}`;
    
    showMessage(`Uploading ${folder.replace(/-/g, ' ')}...`, 'info');
    try {
        const { error } = await _supabase.storage.from('images').upload(filePath, file, { upsert: true });
        if (error) throw error;
        const { data } = _supabase.storage.from('images').getPublicUrl(filePath);
        showMessage('Upload successful!', 'success');
        return data.publicUrl;
    } catch (error) {
        showMessage(`Upload failed: ${error.message}`, 'error'); return null;
    }
}

async function handleLogoUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    logoUrl = await uploadImage(file, 'card-template-logos');
    if (logoUrl) { logoPreview.src = logoUrl; renderElements(); }
}

async function handleBackgroundUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const newBgUrl = await uploadImage(file, 'card-template-backgrounds');
    if (newBgUrl) {
        backgroundUrls[currentSide] = newBgUrl;
        backgroundUrlInput.value = newBgUrl;
        cardPreview.style.backgroundImage = `url('${newBgUrl}')`;
    }
}

async function saveTemplate() {
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
    try {
        const { data: { session } } = await _supabase.auth.getSession();
        if (!session) throw new Error('You must be logged in to save.');
        const orientation = document.querySelector('input[name="orientation"]:checked').value;
        const canvasSize = orientation === 'portrait' ? { width: 255, height: 405 } : { width: 405, height: 255 };
        const payload = {
            id: currentTemplateId, template_name: templateNameInput.value,
            orientation, logo_url: logoUrl,
            background_front_url: backgroundUrls.front, background_back_url: backgroundUrls.back,
            layout_config_front: layoutConfigs.front, layout_config_back: layoutConfigs.back,
            canvas_width_px: canvasSize.width, canvas_height_px: canvasSize.height
        };
        const response = await fetch(`${baseUrl}/.netlify/functions/upsert-card-template`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${session.access_token}` },
            body: JSON.stringify(payload)
        });
        if (!response.ok) {
            const err = await response.json(); throw new Error(err.message || 'Failed to save.');
        }
        const savedTemplate = await response.json();
        if (!currentTemplateId) {
            currentTemplateId = savedTemplate.id;
            window.history.pushState({}, '', `?template_id=${currentTemplateId}`);
            editorTitle.textContent = `Editing: ${savedTemplate.template_name}`;
        }
        showMessage('Template saved successfully!', 'success');
    } catch (error) {
        showMessage(error.message, 'error');
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Template';
    }
}

function showMessage(msg, type) {
    const messageEl = document.getElementById('message');
    if(!messageEl) return;
    messageEl.textContent = msg;
    messageEl.style.color = type === 'error' ? '#721c24' : '#155724';
    messageEl.style.backgroundColor = type === 'error' ? '#f8d7da' : '#d4edda';
    messageEl.style.padding = '10px';
    messageEl.style.borderRadius = '4px';
    messageEl.style.display = 'block';
    setTimeout(() => { messageEl.style.display = 'none'; }, 5000);
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch(`${baseUrl}/.netlify/functions/get-config`);
        const config = await response.json();
        _supabase = supabase.createClient(config.supabaseUrl, config.supabaseKey);
        const { data: { session } } = await _supabase.auth.getSession();
        if (!session) { document.body.innerHTML = '<h1>Please log in.</h1>'; return; }
        const urlParams = new URLSearchParams(window.location.search);
        const templateIdFromUrl = urlParams.get('template_id');
        if (templateIdFromUrl) {
            await loadTemplateData(templateIdFromUrl);
        } else {
            switchView('front');
        }
        frontViewBtn.addEventListener('click', () => switchView('front'));
        backViewBtn.addEventListener('click', () => switchView('back'));
        document.querySelectorAll('input[name="orientation"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                cardPreview.className = `card-preview ${e.target.value}`;
                activeElementId = null; updatePropertiesPanel();
            });
        });
        backgroundUrlInput.addEventListener('input', (e) => {
            backgroundUrls[currentSide] = e.target.value;
            cardPreview.style.backgroundImage = `url('${e.target.value}')`;
        });
        backgroundUploadInput.addEventListener('change', handleBackgroundUpload);
        logoUploadInput.addEventListener('change', handleLogoUpload);
        saveBtn.addEventListener('click', saveTemplate);
    } catch(error) {
        showMessage('Initialization Error: ' + error.message, 'error');
    }
});
</script>

</body>
</html>